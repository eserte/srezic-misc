#
# $Id: SlayMakefile,v 1.9 2008/02/23 16:59:56 eserte Exp $
#

{
    package MyPH;
    use base 'Pod::Simple::HTML';
    sub html_header_after_title {
	my $self = shift;
	if (@_) {
	    $self->SUPER::html_header_after_title(@_);
	} else {
	    $self->SUPER::html_header_after_title . "\n<h1>CPAN in a nutshell</h1>";
	}
    }
    sub html_footer {
	my $self = shift;
	if (@_) {
	    $self->SUPER::html_footer(@_);
	} else {
	     "\n<h1>Author</h1>Slaven Rezi&#x107;" . $self->SUPER::html_footer;
	}
    }
    sub force_title { "CPAN in a nutshell" }
    sub index {1}
    sub html_css { "http://search.cpan.org/s/style.css" }
}

{
    sub test_cpantestersmatrix {
        my(@cgi_args) = @_;
	local $ENV{SCRIPT_NAME} = "cpantestersmatrix.pl"; # to avoid warnings
	my $content = `perl -wT cgi/cpantestersmatrix.pl @cgi_args`;
	Test::More::is($?, 0, "Exit code for @cgi_args");
	Test::More::ok($content, "Have content for @cgi_args");
	Test::More::like($content, qr{content-type:\s*text/html}i, "Seen http header");
	Test::More::unlike($content, qr{error}i, "No error seen");
	Test::More::like($content, qr{other links}i, "Some expected content");
    }
}

all: permissions cpan_in_a_nutshell.html

cpan_in_a_nutshell.html: cpan_in_a_nutshell.pod SlayMakefile
	{
	    MyPH->parse_from_file("cpan_in_a_nutshell.pod", "cpan_in_a_nutshell.html");
	    "";
	}

permissions:
	cd scripts && chmod ugo+rx *
	cd cgi && chmod ugo+rx *
	chmod ugo+rx scripts cgi

rsync-cpantestersmatrix-stable:
	rsync -av ~/work/srezic-misc/cgi/cpantestersmatrix.pl root@bbbike.radzeit.de:/home/slaven/cpantestersmatrix.pl

rsync-cpantestersmatrix-devel:
	rsync -av ~/work/srezic-misc/cgi/cpantestersmatrix.pl root@bbbike.radzeit.de:/home/slaven/cpantestersmatrix2.pl

test-cpantestersmatrix-local:
	{
	    require Test::More; Test::More::plan('no_plan');
	    test_cpantestersmatrix 'dist=Tk';
	    test_cpantestersmatrix 'dist=Tk 804.027';
	    test_cpantestersmatrix 'dist=JSON', 'maxver=1';
	    test_cpantestersmatrix 'dist=Clarion';
	    test_cpantestersmatrix 'author=srezic';
	    "";
	}
