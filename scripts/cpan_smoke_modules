#!/usr/bin/perl -w
# -*- perl -*-

#
# $Id: cpan_smoke_modules,v 1.1 2007/10/06 12:12:56 eserte Exp $
# Author: Slaven Rezic
#
# Copyright (C) 2007 Slaven Rezic. All rights reserved.
# This program is free software; you can redistribute it and/or
# modify it under the same terms as Perl itself.
#
# Mail: slaven@rezic.de
# WWW:  http://www.rezic.de/eserte/
#

use strict;
use Getopt::Long;
my @perls = qw(perl5.8.8 perl5.10.0 perl5.6.2 perl5.00505);
my $do_action = "report";
my $n;
GetOptions("n" => \$n,
	   "install" => sub { $do_action = "install" })
    or die "usage!";
my @dist_or_mods = @ARGV;
if (!@dist_or_mods) {
    die "dist or mod?";
}

for my $dist_or_mod (@dist_or_mods) {
    print STDERR "#"x70, "\n";
    print STDERR "# Module/Distribution $dist_or_mod\n";
    for my $perl (@perls) {
	print STDERR "# ", "#"x68,"\n";
	print STDERR "# # $perl\n";
	my @cmd = ($perl, "-MCPAN", "-e", $do_action.qq{("$dist_or_mod")});
	if ($n) {
	    unshift @cmd, "echo";
	}
	print STDERR "# # @cmd\n";
	system @cmd;
	if ($? & 127) {
	    die sprintf("Child died with signal %d, %s coredump\n",
			($? & 127),  ($? & 128) ? 'with' : 'without');
	}
    }
}

__END__
