#!/usr/bin/perl

use strict;
use FindBin;
use Getopt::Long;

sub run_smoker ($$$);

my $do_this_month = 1;
my $do_last_month = 1;
my $do_recent;

my $do_maintperl;
my $do_all;
my $do_special;

my $skip_update;

my $use_pause = 0; # cpantesters.org should be good enough # 2012-08-06: missing files, switch to PAUSE # 2012-10-19 switch to cpantesters.org again # Since 2013-01-01 there's no ftp @ pause anymore

GetOptions("maintperl" => \$do_maintperl,
	   "all"       => \$do_all,
	   "special"   => \$do_special,
	   "this!"     => \$do_this_month,
	   "last!"     => \$do_last_month,
	   "recent"    => \$do_recent,
	   "skip-update" => \$skip_update,
	   "pause!"    => \$use_pause,
	  )
    or die "usage?";

my $recent_url = $use_pause ? "ftp://pause.perl.org/pub/PAUSE/" : "http://cpan.cpantesters.org/"; # was:"ftp://ftp.funet.fi/pub/CPAN/";
my $bleedingedge = $use_pause ? "-bleedingedge" : "-nobleedingedge";

if (!$do_maintperl && !$do_all && !$do_special) {
    die "Please specify either -maintperl or -all or -special";
}

if ($do_maintperl) {
    system('xterm-conf -f -title "INIT maintperl"');
    # really tests 5.8.8 and 5.8.9, installs everything stable and
    # tests also developer versions
    (getpwuid($<))[0] eq 'cpansand'
	or die "Works only for cpansand!";

    run_smoker '5.16.0-RC0', 'devel',  '-3d';
    run_smoker '5.16.0-RC0', 'stable', '-20d';

    run_smoker '5.14.0', 'devel',  '-3d';
    run_smoker '5.12.3', 'devel',  '-3d';
    #run_smoker '5.12.0', 'devel',  '-3d';
    run_smoker '5.10.1', 'devel',  '-3d';
    run_smoker '5.8.9',  'devel',  '-3d';
    run_smoker '5.14.0', 'stable', '-20d';
    run_smoker '5.12.3', 'stable', '-20d';
    #run_smoker '5.12.0', 'stable', '-20d';
    run_smoker '5.10.1', 'stable', '-20d';
    run_smoker '5.8.9',  'stable', '-20d';

#    warn "*** 5.8.9: Just test recent uploads, also devel versions...\n";
#    system q{env PERL_BATCH=yes PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/set-perl588-7.0 ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -install -perl /usr/perl5.8.8@RELEASE/bin/perl -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -url } . $recent_url . q{ -from -3d -v -stable | grep -v '\.pl$'`};
#    warn "*** 5.8.8: Just test recent uploads, also devel versions...\n";
#    system q{env PERL_BATCH=yes PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/set-perl589@RC2-7.0 ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -install -perl /usr/perl5.8.9@RC2/bin/perl -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -url } . $recent_url . q{ -from -3d -v -stable | grep -v '\.pl$'`};
#
#    # only stable
#    warn "*** 5.12.0: Test and install recent uploads, only stable versions...\n";
#    system q{env PERL_BATCH=yes ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -perl /usr/perl5.12.0/bin/perl -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -url } . $recent_url . q{ -from -20d -v | grep -v '\.pl$'`};
#    warn "*** 5.10.1: Test and install recent uploads, only stable versions...\n";
#    system q{env PERL_BATCH=yes ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -perl /usr/perl5.10.1/bin/perl -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -url } . $recent_url . q{ -from -20d -v | grep -v '\.pl$'`};
#    warn "*** 5.8.9: Test and install recent uploads, only stable versions...\n";
#    system q{env PERL_BATCH=yes PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/set-perl589@RC2-7.0 ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -perl /usr/perl5.8.9@RC2/bin/perl -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -url } . $recent_url . q{ -from -20d -v | grep -v '\.pl$'`};
#    warn "*** 5.8.8: Test and install recent uploads, only stable versions...\n";
#    system q{env PERL_BATCH=yes PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/set-perl588-7.0 ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -perl /usr/perl5.8.8@RELEASE/bin/perl -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -url } . $recent_url . q{ -from -20d -v | grep -v '\.pl$'`};
#

#     print STDERR <<'EOF';
# *** Now as eserte:
# 
# ctr_good_or_invalid.pl ~cpansand/var/perl5.10.1-7.0-test/ctr1/ -sort date -r; ctr_good_or_invalid.pl ~cpansand/var/perl5.8.9@RC2-7.0-test/ctr1/ -sort date -r; ctr_good_or_invalid.pl ~cpansand/var/perl5.8.8-7.0-test/ctr1/ -sort date -r
# send_tr_reports.pl ~cpansand/var/perl5.10.1-7.0-test/ctr1/; send_tr_reports.pl ~cpansand/var/perl5.8.9@RC2-7.0-test/ctr1/; send_tr_reports.pl ~cpansand/var/perl5.8.8-7.0-test/ctr1/    
# 
# *** Or only the PASSes without inspection:
# 
# ctr_good_or_invalid.pl ~cpansand/var/perl5.10.1-7.0-test/ctr1/ -good; ctr_good_or_invalid.pl ~cpansand/var/perl5.8.9@RC2-7.0-test/ctr1/ -good; ctr_good_or_invalid.pl ~cpansand/var/perl5.8.8-7.0-test/ctr1/ -good
# send_tr_reports.pl ~cpansand/var/perl5.10.1-7.0-test/ctr1/; send_tr_reports.pl ~cpansand/var/perl5.8.9@RC2-7.0-test/ctr1/; send_tr_reports.pl ~cpansand/var/perl5.8.8-7.0-test/ctr1/    
# 
# EOF
    system('xterm-conf -f -title "FINISHED maintperl"');
} elsif (0 && $do_maintperl) { # old, somewhat newer
    (getpwuid($<))[0] eq 'cpansand'
	or die "Works only for cpansand!";
    unless ($skip_update) {
	my @cmd = "~eserte/devel/update-allcpanpackages";
	warn "@cmd...\n";
	if (system(@cmd) != 0) {
	    die "update failed";
	}
    }

    my(undef,undef,undef,undef,$m,$y) = localtime;
    $m++;
    $y+=1900;
    my $this_month = sprintf "%04d-%02d-", $y, $m;
    $m--;
    if ($m < 1) {
	$m = 12;
	$y--;
    }
    my $last_month = sprintf "%04d-%02d-", $y, $m;

    my $cmd = <<'EOF';
env PERL_BATCH=yes PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/set3 ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -install -nodestroyperl -skiptested -perl /usr/perl5.8.8@34559/bin/perl `sort -r ~cpansand/var/tested-cpan-FreeBSD-5.8.8@34559 | grep -v '^\?' | egrep '(untested|not the latest version)' | egrep '^__DATE__' | sort -r | perl -nale 'print $F[1]'`
EOF
    $cmd =~ s{__DATE__}{($this_month|$last_month)};
    warn "Running '$cmd'...\n";
    system $cmd;
    if ($? != 0) {
	die "Command failed with $?";
    }
} elsif (0 && $do_maintperl) { # old
    unless ($skip_update) {
	my @cmd = "~eserte/devel/update-allcpanpackages";
	warn "@cmd...\n";
	if (system(@cmd) != 0) {
	    die "update failed";
	}
    }
#     if (!$do_this_month && !$do_last_month) {
# 	$do_this_month = 1;
#     }
    my(undef,undef,undef,undef,$m,$y) = localtime;
    $m++;
    $y+=1900;
    my $this_month = sprintf "%04d-%02d-", $y, $m;
    $m--;
    if ($m < 1) {
	$m = 12;
	$y--;
    }
    my $last_month = sprintf "%04d-%02d-", $y, $m;
    my @cmd = ("$FindBin::RealBin/cpan_smoke_modules",
	       "-skiptested", "-install",
	       "-perl", '/usr/perl5.8.8@34559/bin/perl'
	      );
    my @dists;
    {
	open my $fh, "$ENV{HOME}/var/tested-cpan-FreeBSD-5.8.8"
	    or die $!;
	while(<$fh>) {
	    chomp;
	    my @F = split;
	    push @dists, $F[1]
		if (($do_this_month && $F[0] =~ m{^\Q$this_month}) ||
		    ($do_last_month && $F[0] =~ m{^\Q$last_month}));
	}
    }
    if (!@dists) {
	warn "No distributions to test...\n";
	exit;
    }
    push @cmd, @dists;
    warn "@cmd...\n";
    if (system(@cmd) != 0) {
	die "Failed while running command";
    }
} elsif (0) {
    my @dists;
    {
	open my $fh, "-|", "$FindBin::RealBin/cpan_recent_uploads"
	    or die "While running cpan_recent_uploads: $!";
	while(<$fh>) {
	    chomp;
	    push @dists, $_;
	}
    }
    my @cmd = ("$FindBin::RealBin/cpan_smoke_modules", "-skiptested", "-nobleededge", @dists);
    warn "@cmd...\n";
    if (system(@cmd) != 0) {
	die "Failure while running command\n";
    }
} elsif ($do_special) {
    warn <<EOF;
*** 5.8.9: Special test: test breakage of the Test::Pod 1.40 change
    (some L<...> errors recognized, see
     http://perlbuzz.com/2009/07/testpod-140-now-checks-for-illegal-l-constructs.html
    )...
EOF
    system q{env PERL_BATCH=yes PERL_CPAN_REPORTER_DIR=$HOME/.cpanreporter/set-perl589@RC2-7.0 ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -nosignalend -perl /usr/perl5.8.9@RC2/bin/perl } . $bleedingedge . q{ -filelist ~eserte/trash/has_podt2};
} else {
    chomp(my @dists = `$FindBin::RealBin/cpan_recent_uploads2 -v -from -6d -url $recent_url`);
    my @cmd = ("$FindBin::RealBin/cpan_smoke_modules", "-pv", "5.10.0,5.8.8t,5.10.0t,5.6.2,5.8.8",
	       $bleedingedge, "-skiptested", "--", @dists);
    warn "Running: @cmd\n";
    if (system(@cmd) != 0) {
	die "Failure while running command: @cmd\n";
    }
}

sub run_smoker ($$$) {
    my($perl_version, $stability, $interval) = @_;
    warn "*** $perl_version: Just test uploads last $interval, " . ($stability eq 'stable' ? 'only stable' : 'also devel') . " versions...\n";
    my $perl_exe = '/usr/perl' . $perl_version . '/bin/perl' . $perl_version;
    if (!-x $perl_exe) {
	$perl_exe = '/usr/local/bin/perl' . $perl_version;
	if (!-x $perl_exe) {
	    die "Cannot find a perl $perl_version, tried in /usr/perlXXX and $perl_exe";
	}
    }
    my $cmd = q{env PERL_BATCH=yes ~eserte/work/srezic-misc/scripts/cpan_smoke_modules -savereports -nosignalend } . ($stability eq 'stable' ? '-install' : '') . q{ -perl } . $perl_exe . q{ -skiptested -r } . $bleedingedge . q{ -- `~eserte/work/srezic-misc/scripts/cpan_recent_uploads2 -onlydists -url } . $recent_url . q{ -from } . $interval . q{ -v } . ($stability eq 'stable' ? '-stable' : '') . q{ | grep -v '\.pl$'`};
    warn "$cmd ...\n";
    system $cmd;
    if ($? == 2) {
	die "SIGINT";
    }
}
